<div class="flow-header-glass">
  <!-- Subtle animated mesh background -->
  <div class="animated-mesh"></div>
  
  <!-- Main header content -->
  <div class="header-glass-container">
    
    <!-- Left Section: Book Info & Progress -->
    <div class="header-left-section">
      
      <!-- Book Selector with Testament Filter -->
      <div class="book-selector-wrapper">
        <!-- Testament Filter -->
        <div class="testament-filter">
          <button 
            [class.active]="testamentFilter === 'ALL'"
            (click)="setTestamentFilter('ALL')"
          >
            ALL
          </button>
          <button 
            [class.active]="testamentFilter === 'OT'"
            (click)="setTestamentFilter('OT')"
          >
            OT
          </button>
          <button 
            [class.active]="testamentFilter === 'NT'"
            (click)="setTestamentFilter('NT')"
          >
            NT
          </button>
          <button 
            [class.active]="testamentFilter === 'APO'"
            (click)="setTestamentFilter('APO')"
          >
            APO
          </button>
        </div>
        
          <!-- Book Selector Dropdown -->
          <select class="book-select" (change)="onBookSelect($any($event.target).value)">
            <option *ngFor="let book of filteredBooks" [value]="book.id" [selected]="book.id === currentBook?.id">
              {{ book.name }}
            </option>
          </select>
        </div>
      
      <!-- Progress Container -->
      <div class="progress-stats-container">
  
        <!-- LARGER Progress Ring -->
        <div class="progress-ring-large">
          <svg width="120" height="120">
            <defs>
              <linearGradient id="gradient-ring" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" stop-color="#34d399" />
                <stop offset="100%" stop-color="#10b981" />
              </linearGradient>
            </defs>
            <circle cx="60" cy="60" r="54" class="ring-bg"></circle>
            <circle cx="60" cy="60" r="54" class="ring-fill" 
                    [attr.stroke-dasharray]="progressCircumference" 
                    [attr.stroke-dashoffset]="progressOffset"></circle>
          </svg>
          <div class="ring-percentage">{{ progressPercentage }}%</div>
        </div>
  
          <!-- Verses statistic pill moved below the progress ring -->
          <div class="verses-pill stat-card-glass">
            <span class="stat-label">Verses</span>
            <span class="stat-value">{{ memorizedBookVerses }} / {{ totalBookVerses }}</span>
          </div>
      </div>
      
      <!-- Action Buttons -->
      <div class="action-buttons-glass">
        <button class="btn-glass-action toggle-text" (click)="toggleTextMode.emit()">
          <svg *ngIf="!showFullText" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
            <circle cx="12" cy="12" r="3"></circle>
          </svg>
          <svg *ngIf="showFullText" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
            <line x1="1" y1="1" x2="23" y2="23"></line>
          </svg>
          {{ showFullText ? 'Show FLOW' : 'Show Full Text' }}
        </button>
        
        <button class="btn-glass-action primary" (click)="onStartButtonClick()">
          <svg *ngIf="selectedVersesCount === 0" width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
            <path d="M8 5v14l11-7z"/>
          </svg>
          <svg *ngIf="selectedVersesCount > 0" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
            <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
          </svg>
          <span *ngIf="selectedVersesCount === 0">Start Full Chapter</span>
          <span *ngIf="selectedVersesCount > 0">Study {{ selectedVersesCount }} Selected</span>
        </button>
      </div>
    </div>
    
    <!-- Right Section: Chapters Grid -->
    <div class="chapters-section">
      
      <!-- Filter Controls -->
      <div class="chapters-controls-bar">
        <div class="filter-pills">
          <button 
            class="filter-pill" 
            [class.active]="activeChapterFilter === 'all'"
            (click)="setChapterFilter('all')"
          >
            All
          </button>
          <button 
            class="filter-pill" 
            [class.active]="activeChapterFilter === 'inProgress'"
            (click)="setChapterFilter('inProgress')"
          >
            In Progress
          </button>
          <button 
            class="filter-pill" 
            [class.active]="activeChapterFilter === 'completed'"
            (click)="setChapterFilter('completed')"
          >
            Completed
          </button>
        </div>
        
        <div class="chapter-controls-right">
          <span class="chapter-count">{{ filteredChapters.length }} chapters</span>
          <button class="view-toggle-btn" (click)="toggleChapterView()" title="Change view">
            {{ getViewModeIcon() }}
          </button>
        </div>
      </div>
      
      <!-- Chapters Grid View -->
      <div class="chapters-grid-glass" *ngIf="chapterViewMode === 'grid'">
        <div 
          *ngFor="let chapter of visibleChapters"
          class="chapter-card-glass"
          [class.current]="chapter.isCurrent"
          [class.completed]="chapter.isCompleted"
          (click)="onChapterClick(chapter.number)"
        >
          <div class="completed-icon" *ngIf="chapter.isCompleted">âœ“</div>
          <div class="ch-number">Ch {{ chapter.number }}</div>
          
          <!-- PIE CHART instead of progress bar for grid mode -->
          <div class="chapter-pie-chart">
            <svg width="40" height="40">
              <defs>
                <linearGradient [id]="'ch-gradient-' + chapter.number" x1="0%" y1="0%" x2="100%" y2="100%">
                  <stop offset="0%" [attr.stop-color]="chapter.isCurrent ? '#fff' : '#667eea'" />
                  <stop offset="100%" [attr.stop-color]="chapter.isCurrent ? '#fff' : '#764ba2'" />
                </linearGradient>
              </defs>
              <circle cx="20" cy="20" r="18" class="pie-bg"></circle>
              <circle cx="20" cy="20" r="18" class="pie-fill"
                      [attr.stroke]="chapter.isCurrent ? '#fff' : 'url(#ch-gradient-' + chapter.number + ')'
                        "
                      [attr.stroke-dasharray]="getChapterPieCircumference()" 
                      [attr.stroke-dashoffset]="getChapterPieOffset(chapter.progressPercentage)"></circle>
            </svg>
            <div class="pie-percentage">{{ chapter.progressPercentage }}%</div>
          </div>
          
          <div class="ch-verses">
            {{ chapter.memorizedVerses }}/{{ chapter.totalVerses }}
          </div>
          <div class="ch-last-studied" *ngIf="chapter.lastStudied">
            {{ chapter.lastStudied }}
          </div>
        </div>
      </div>
      
      <!-- Chapters Row View -->
      <div class="chapters-list-glass" *ngIf="chapterViewMode === 'row'">
        <div 
          *ngFor="let chapter of visibleChapters"
          class="chapter-row"
          [class.current]="chapter.isCurrent"
          [class.completed]="chapter.isCompleted"
          (click)="onChapterClick(chapter.number)"
        >
          <div class="row-number">Ch {{ chapter.number }}</div>
          <div class="row-progress">
            <div class="progress-bar-row">
              <div 
                class="progress-fill-row" 
                [style.width.%]="chapter.progressPercentage"
              ></div>
            </div>
          </div>
          <div class="row-stats">
            <span class="verses-count">{{ chapter.memorizedVerses }}/{{ chapter.totalVerses }}</span>
            <span class="percentage">{{ chapter.progressPercentage }}%</span>
          </div>
          <div class="row-last-studied" *ngIf="chapter.lastStudied">
            {{ chapter.lastStudied }}
          </div>
        </div>
      </div>
      
      <!-- Chapters List View -->
      <div class="chapters-detailed-glass" *ngIf="chapterViewMode === 'list'">
        <div 
          *ngFor="let chapter of visibleChapters"
          class="chapter-list-item"
          [class.current]="chapter.isCurrent"
          [class.completed]="chapter.isCompleted"
          (click)="onChapterClick(chapter.number)"
        >
          <div class="list-header">
            <span class="list-number">Chapter {{ chapter.number }}</span>
            <span class="list-badge" *ngIf="chapter.isCurrent">Current</span>
            <span class="list-badge completed" *ngIf="chapter.isCompleted">Complete</span>
          </div>
          <div class="list-progress">
            <div class="progress-bar-list">
              <div 
                class="progress-fill-list" 
                [style.width.%]="chapter.progressPercentage"
              ></div>
            </div>
          </div>
          <div class="list-footer">
            <span>{{ chapter.memorizedVerses }} of {{ chapter.totalVerses }} verses ({{ chapter.progressPercentage }}%)</span>
            <span class="last-studied" *ngIf="chapter.lastStudied">Last studied: {{ chapter.lastStudied }}</span>
          </div>
        </div>
      </div>
    </div>
    
  </div>
</div>
