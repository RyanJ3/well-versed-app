<div class="flow-memorization-container" (mouseup)="handleMouseUp()">
  <!-- NEW Glassmorphism Header Component (includes chapter navigation) -->
  <app-flow-header
    [currentBook]="currentBook"
    [currentChapter]="currentChapter"
    [totalChapters]="currentBook?.totalChapters || 50"
    [memorizedVersesCount]="memorizedVersesCount"
    [totalVerses]="verses.length"
    [progressPercentage]="progressPercentage"
    [selectedVersesCount]="selectionService.selectedVerses.size"
    [showFullText]="showFullText"
    [availableChapters]="availableChapters"
    [allBooks]="allBooks"
    (toggleTextMode)="toggleTextMode()"
    (startFullChapter)="startFullChapter()"
    (startStudySession)="startStudySession()"
    (changeChapter)="changeChapter($event)"
    (changeBook)="changeBook($event)"
  ></app-flow-header>

  <!-- Encouragement Message (keep as is) -->
  <div class="encouragement-message" *ngIf="showEncouragement" [@fadeInOut]>
    {{ showEncouragement }}
  </div>

  <!-- Quick Filters (keep as is) -->
  <app-filters-bar
    [activeFilter]="activeFilter"
    [totalVerses]="verses.length"
    [unmemorizedCount]="unmemorizedVersesCount"
    [needsReviewCount]="needsReviewCount"
    [sectionCount]="verseSections.length"
    (filterChange)="activeFilter = $event"
  ></app-filters-bar>

  <!-- Selection Info -->
  <div class="selection-info" *ngIf="selectionService.selectedVerses.size > 0">
    <span>{{ selectionService.selectedVerses.size }} verses selected • Shift+Click for range • Ctrl/Cmd+A to select all</span>
    <button (click)="selectionService.clearSelection()" class="clear-selection-btn">
      Clear selection (Esc)
    </button>
  </div>

  <!-- Main Content Area -->
  <div class="verses-container" #versesContainer>
    <div class="instructions" *ngIf="verses.length === 0 && !isLoading">
      Right-click for options • Space to select • Enter to study • Arrow keys to navigate
    </div>

    <!-- Loading State -->
    <div *ngIf="isLoading" class="loading-state">
      <div class="spinner"></div>
      <p>Loading verses...</p>
    </div>

    <!-- Section View -->
    <div *ngIf="activeFilter === 'sections' && !isLoading" class="sections-view">
      <div *ngFor="let section of verseSections; let sectionIdx = index" class="section-group">
        <div
          class="section-header"
          (mouseenter)="hoveredSection = sectionIdx"
          (mouseleave)="hoveredSection = -1"
          (click)="selectSection(section)"
        >
          <h3>{{ section.name }}</h3>
          <div class="section-divider"></div>
          <span class="section-range">Verses {{ section.start + 1 }}-{{ section.end + 1 }}</span>
          <button *ngIf="hoveredSection === sectionIdx" class="select-all-btn">
            Select All
          </button>
        </div>

        <div class="verses-grid">
          <div
            *ngFor="let verse of verses.slice(section.start, section.end + 1); let i = index"
            [class]="getVerseState(verse, section.start + i)"
            [style.fontSize.px]="fontSize"
            (click)="handleVerseClick(section.start + i, $event)"
            (dblclick)="handleVerseDoubleClick(verse)"
            (mousedown)="handleMouseDown(section.start + i)"
            (mouseenter)="handleMouseEnter(section.start + i)"
            (contextmenu)="handleContextMenu($event, verse)"
          >
            <div class="new-paragraph-marker" *ngIf="isNewParagraph(verse)">
              ¶ New paragraph
            </div>

            <div class="verse-checkmark" *ngIf="verse.isMemorized">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
            </div>

            <div class="verse-selected-check" *ngIf="isVerseSelected(verse) && !verse.isMemorized">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
            </div>

            <div class="review-indicator" *ngIf="needsReview(verse.verseCode) && verse.isMemorized">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14" fill="none" stroke="white" stroke-width="2"></polyline>
              </svg>
            </div>

            <div class="verse-ref">v{{ verse.verse }}</div>
            <div class="verse-text" [class.full-text]="showFullText">
              {{ getVerseDisplay(verse) }}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Regular Grid View -->
    <div *ngIf="activeFilter !== 'sections' && !isLoading && verses.length > 0" class="verses-grid">
      <div
        *ngFor="let verse of getFilteredVerses(); let i = index"
        [class]="getVerseState(verse, i)"
        [style.fontSize.px]="fontSize"
        (click)="handleVerseClick(i, $event)"
        (dblclick)="handleVerseDoubleClick(verse)"
        (mousedown)="handleMouseDown(i)"
        (mouseenter)="handleMouseEnter(i)"
        (contextmenu)="handleContextMenu($event, verse)"
      >
        <div class="new-paragraph-marker" *ngIf="isNewParagraph(verse)">
          ¶ New paragraph
        </div>

        <div class="verse-checkmark" *ngIf="verse.isMemorized">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
        </div>

        <div class="verse-selected-check" *ngIf="isVerseSelected(verse) && !verse.isMemorized">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
        </div>

        <div class="review-indicator" *ngIf="needsReview(verse.verseCode) && verse.isMemorized">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12 6 12 12 16 14" fill="none" stroke="white" stroke-width="2"></polyline>
          </svg>
        </div>

        <div class="verse-ref">v{{ verse.verse }}</div>
        <div class="verse-text" [class.full-text]="showFullText">
          {{ getVerseDisplay(verse) }}
        </div>
      </div>
    </div>
  </div>

  <!-- Context Menu -->
  <app-flow-context-menu
    *ngIf="contextMenu.visible"
    [contextMenu]="contextMenu"
    [flashcardDecks]="flashcardDecks"
    [selectedVerseIsMemorized]="selectedVerseIsMemorized"
    [shouldShowMarkAsMemorized]="shouldShowMarkAsMemorized"
    [shouldShowMarkAsUnmemorized]="shouldShowMarkAsUnmemorized"
    (markAsMemorized)="markSelectedAsMemorized()"
    (markAsUnmemorized)="markSelectedAsUnmemorized()"
    (addToDeck)="addToFlashcardDeck($event)"
  ></app-flow-context-menu>

  <!-- Memorization Modal -->
  <app-memorization-modal
    *ngIf="showModal"
    [verses]="modalVerses"
    [chapterId]="currentBook?.id || 0"
    [chapterName]="modalChapterName"
    [verseCount]="modalVerses.length"
    (completed)="onModalCompleted($event)"
  ></app-memorization-modal>
</div>