<!-- frontend/src/app/deck-editor/deck-editor.component.html -->
<div class="deck-editor-container">
  <!-- Header -->
  <div class="editor-header">
    <button class="back-button" (click)="goBack()">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
      </svg>
      Back to Decks
    </button>
    
    <h1 class="editor-title">Edit Deck: {{ deck?.name }}</h1>
    
    <div class="header-actions">
      <button class="save-button" (click)="updateDeckInfo()" *ngIf="editMode === 'info'" [disabled]="isSaving">
        <span *ngIf="!isSaving">Save Info</span>
        <span *ngIf="isSaving">Saving...</span>
      </button>
    </div>
  </div>

  <!-- Tab Navigation -->
  <div class="tab-navigation">
    <button 
      class="tab-button" 
      [class.active]="editMode === 'verses'"
      (click)="editMode = 'verses'">
      Manage Cards
    </button>
    <button 
      class="tab-button"
      [class.active]="editMode === 'info'"
      (click)="editMode = 'info'">
      Deck Settings
    </button>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="loading-spinner"></div>
    <p>Loading deck...</p>
  </div>

  <!-- Deck Info Tab -->
  <div *ngIf="!isLoading && editMode === 'info'" class="tab-content">
    <div class="form-section">
      <div class="form-group">
        <label for="deck-name">Deck Name</label>
        <input 
          id="deck-name"
          type="text" 
          [(ngModel)]="deckName" 
          placeholder="Enter deck name..."
          class="form-control">
      </div>

      <div class="form-group">
        <label for="deck-description">Description</label>
        <textarea 
          id="deck-description"
          [(ngModel)]="deckDescription" 
          placeholder="Enter deck description..."
          rows="4"
          class="form-control"></textarea>
      </div>

      <div class="form-group">
        <label class="checkbox-label">
          <input 
            type="checkbox" 
            [(ngModel)]="isDeckPublic">
          <span>Make this deck public</span>
        </label>
      </div>
    </div>
  </div>

  <!-- Cards Tab -->
  <div *ngIf="!isLoading && editMode === 'verses'" class="tab-content">
    <!-- Verse Picker Section -->
    <div class="verse-picker-section">
      <h2>Add Verses to Deck</h2>
      <p class="section-description">
        Select individual verses or verse ranges to add as flashcards. Verse ranges will be saved as a single card.
      </p>
      
      <app-verse-picker 
        [theme]="'minimal'"
        [disabledModes]="['chapter']"
        [pageType]="'flashcard'"
        [maximumVerses]="7"
        (selectionChanged)="onVerseSelectionChanged($event)">
      </app-verse-picker>

      <!-- Selection Preview -->
      <div *ngIf="currentSelection" class="selection-preview">
        <div class="preview-header">
          <h3>Selection Preview</h3>
          <div class="selection-info">
            <span class="selection-reference">{{ currentSelection.reference }}</span>
            <span class="selection-count">{{ currentSelection.verseCount }} verse{{ currentSelection.verseCount !== 1 ? 's' : '' }} → 1 card</span>
          </div>
        </div>
        
        <div class="preview-actions">
          <button 
            class="add-verses-button" 
            (click)="addSelectedVerses()"
            [disabled]="isAddingVerses || currentSelection.verseCodes.length === 0">
            <span *ngIf="!isAddingVerses">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
              </svg>
              Add as Flashcard
            </span>
            <span *ngIf="isAddingVerses">
              Adding card...
            </span>
          </button>
        </div>
      </div>
    </div>

    <!-- Current Cards Section -->
    <div class="current-cards-section">
      <div class="section-header">
        <h2>Current Cards ({{ deckCards.length }})</h2>
        <button 
          class="remove-selected-button" 
          (click)="removeSelectedCards()"
          [disabled]="selectedCards.size === 0">
          Remove Selected ({{ selectedCards.size }})
        </button>
      </div>

      <div *ngIf="deckCards.length === 0 && !isLoading" class="empty-state">
        <svg class="empty-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="5" y="3" width="14" height="18" rx="2" stroke="currentColor" stroke-width="2"/>
          <line x1="9" y1="8" x2="15" y2="8" stroke="currentColor" stroke-width="2"/>
          <line x1="9" y1="12" x2="15" y2="12" stroke="currentColor" stroke-width="2"/>
          <line x1="9" y1="16" x2="11" y2="16" stroke="currentColor" stroke-width="2"/>
        </svg>
        <h3>No cards in this deck yet</h3>
        <p>Use the verse picker above to add flashcards to your deck.</p>
      </div>

      <div *ngIf="isLoading" class="loading-message">
        <div class="loading-spinner-small"></div>
        <span>Loading deck cards with verse texts...</span>
      </div>

      <div *ngIf="deckCards.length > 0" class="card-list">
        <div *ngFor="let card of deckCards" 
             class="card-item" 
             [class.selected]="selectedCards.has(card.card_id)">
          <input 
            type="checkbox" 
            [checked]="selectedCards.has(card.card_id)"
            (change)="toggleCardSelection(card.card_id)"
            class="card-checkbox">
          
          <div class="card-content">
            <div class="card-header">
              <div class="card-reference">{{ card.reference }}</div>
              <div class="card-type-badge" [class]="card.card_type">
                {{ card.card_type === 'single_verse' ? 'Single Verse' : 'Verse Range' }}
              </div>
            </div>
            
            <div class="card-verses">
              <!-- Single Verse Display with Proper Guard -->
              <ng-container *ngIf="card.card_type === 'single_verse' && card.verses.length > 0">
                <div class="single-verse-text" *ngIf="card.verses[0].text && !card.verses[0].text.startsWith('Unable to load')">
                  {{ card.verses[0].text }}
                </div>
                <div class="single-verse-text error" *ngIf="!card.verses[0].text || card.verses[0].text.startsWith('Unable to load')">
                  <em>Verse text could not be loaded</em>
                </div>
              </ng-container>
              
              <!-- Verse Range Display with Proper Guards -->
              <ng-container *ngIf="card.card_type === 'verse_range' && card.verses.length > 0">
                <div class="verse-range-content">
                  <div class="verse-summary">
                    {{ card.verses.length }} verses: {{ card.verses[0].reference }}
                    <span *ngIf="card.verses.length > 1">
                      → {{ card.verses[card.verses.length - 1].reference }}
                    </span>
                  </div>
                  <div class="first-verse-preview" *ngIf="card.verses[0].text && !card.verses[0].text.startsWith('Unable to load')">
                    "{{ card.verses[0].text }}"
                    <span *ngIf="card.verses.length > 1" class="more-indicator">
                      ... (+{{ card.verses.length - 1 }} more)
                    </span>
                  </div>
                  <div class="first-verse-preview error" *ngIf="!card.verses[0].text || card.verses[0].text.startsWith('Unable to load')">
                    <em>Verse texts could not be loaded</em>
                  </div>
                </div>
              </ng-container>

              <!-- Fallback for cards with no verses (should not happen, but defensive programming) -->
              <div *ngIf="card.verses.length === 0" class="no-verses-warning">
                <em>No verse data available for this card</em>
              </div>
            </div>
            
            <div *ngIf="card.confidence_score !== null" class="confidence-display">
              Confidence: {{ card.confidence_score }}%
            </div>
          </div>
          
          <button 
            class="remove-button" 
            (click)="removeCardFromDeck(card.card_id)"
            title="Remove card">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>