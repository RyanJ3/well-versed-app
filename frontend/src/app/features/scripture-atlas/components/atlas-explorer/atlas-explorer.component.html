<div class="atlas-explorer">
  <!-- Unified Header -->
  <app-atlas-header
    [journeys]="journeys$ | async"
    [currentJourney]="currentJourney$ | async"
    [testament]="selectedTestament"
    [currentView]="currentView"
    [currentSegmentIndex]="(currentSegmentIndex$ | async) || 0"
    [totalSegments]="(totalSegments$ | async) || 0"
    [collapsed]="headerCollapsed"
    (testamentChange)="onTestamentChange($event)"
    (journeyChange)="onJourneyChange($event)"
    (viewChange)="onViewChange($event)"
    (previousSegment)="onPreviousSegment()"
    (nextSegment)="onNextSegment()"
    (resetView)="onResetView()"
    (togglePanel)="toggleJourneyPanel()"
    (collapsedChange)="headerCollapsed = $event">
  </app-atlas-header>
  
  <!-- Journey Drawer Panel -->
  <app-journey-panel
    #journeyPanel
    [testament]="selectedTestament"
    [journeys]="journeys$ | async"
    [currentJourney]="currentJourney$ | async"
    [currentSegmentIndex]="(currentSegmentIndex$ | async) || 0"
    [totalSegments]="(totalSegments$ | async) || 0"
    [autoHide]="false"
    (testamentChange)="onTestamentChange($event)"
    (journeyChange)="onJourneyChange($event)">
  </app-journey-panel>
  
  <!-- Map Container -->
  <div class="map-container" [class.header-collapsed]="headerCollapsed">
    <app-map-view
      [journey]="currentJourney$ | async"
      [currentSegmentIndex]="(currentSegmentIndex$ | async) || 0"
      [mapView]="currentView"
      (locationHover)="onLocationHover($event)">
    </app-map-view>
    
    <!-- FAB Navigation (Mobile + Tablet) -->
    <app-fab-navigation
      [currentSegmentIndex]="(currentSegmentIndex$ | async) || 0"
      [totalSegments]="(totalSegments$ | async) || 0"
      [hideOnDesktop]="true"
      (previousSegment)="onPreviousSegment()"
      (nextSegment)="onNextSegment()"
      (resetView)="onResetView()">
    </app-fab-navigation>
    
    <!-- Segment Details Bottom Sheet -->
    <app-segment-details
      [segment]="currentSegment$ | async"
      [collapsed]="segmentDetailsCollapsed"
      (toggle)="segmentDetailsCollapsed = !segmentDetailsCollapsed"
      (collapsedChange)="segmentDetailsCollapsed = $event">
    </app-segment-details>
    
    <!-- Location Tooltip -->
    <div class="location-tooltip" 
         *ngIf="hoveredLocation"
         [style.left.px]="tooltipPosition.x" 
         [style.top.px]="tooltipPosition.y">
      <h4>{{ hoveredLocation.name }}</h4>
      <p *ngIf="hoveredLocation.modernName">Modern: {{ hoveredLocation.modernName }}</p>
      <p *ngIf="hoveredLocation.distanceFromStart">Distance: {{ hoveredLocation.distanceFromStart }}km</p>
    </div>
  </div>
  
  <!-- Keyboard Help Dialog -->
  <app-keyboard-help-dialog
    [isOpen]="showKeyboardHelp"
    (close)="closeKeyboardHelp()">
  </app-keyboard-help-dialog>
</div>