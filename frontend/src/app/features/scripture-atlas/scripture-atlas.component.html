<div class="atlas-container">
  <app-scripture-atlas-header
    [journeys]="journeys"
    [selectedJourneyId]="selectedJourneyId"
    [selectedJourney]="selectedJourney"
    [isPlaying]="isPlaying"
    [terrainView]="terrainView"
    [splitView]="splitView"
    [sidebarOpen]="sidebarOpen"
    [timelineProgress]="timelineProgress"
    [currentCityIndex]="currentCityIndex"
    [citiesLength]="cities.length"
    [memorizedCount]="memorized.size"
    [progressPercentage]="getProgressPercentage()"
    [currentDistance]="currentDistance"
    (journeyChange)="loadJourney($event)"
    (togglePlayback)="toggleJourneyPlayback()"
    (toggleTerrain)="toggleTerrainView()"
    (toggleSplit)="toggleSplitView()"
    (toggleSidebar)="toggleSidebar()"
    (timelineChange)="onTimelineChange($event)"
  >
    <ng-container timeline-markers>
      <div
        *ngFor="let city of cities; index as i"
        class="timeline-marker"
        [class.visited]="i <= currentCityIndex"
        [class.active]="selectedCity?.id === city.id"
        [class.memorized]="memorized.has(city.id)"
        [style.left.%]="(i / (cities.length - 1)) * 100"
        (click)="selectCity(city)"
        [title]="city.name"
      >
        <div class="marker-dot"></div>
        <div class="marker-label">{{ i + 1 }}</div>
      </div>
    </ng-container>
  </app-scripture-atlas-header>

  <!-- Main Layout -->
  <div class="atlas-main">
    <app-scripture-atlas-sidebar
      [sidebarOpen]="sidebarOpen"
      [sidebarView]="sidebarView"
      [selectedCity]="selectedCity"
      [memorized]="memorized"
      [versesRead]="versesRead"
      [currentScriptureText]="currentScriptureText"
      (sidebarViewChange)="sidebarView = $event"
      (close)="sidebarOpen = false"
      (toggleMemorized)="toggleMemorized($event)"
      (markVersesAsRead)="markVersesAsRead()"
    ></app-scripture-atlas-sidebar>

    <!-- Map Area (Full Width) -->
    <div class="map-area">
      <!-- Split View Container -->
      <div class="maps-container" [class.split]="splitView">
        <!-- Modern Map -->
        <div class="map-wrapper" [class.half]="splitView">
          <div id="modern-map" class="map-instance"></div>
          <div class="map-label" *ngIf="splitView">Modern View</div>
        </div>

        <!-- Ancient Map -->
        <div class="map-wrapper" [class.half]="splitView" *ngIf="splitView">
          <div id="ancient-map" class="map-instance"></div>
          <div class="map-label">Ancient View</div>
        </div>
      </div>

      <!-- Navigation Buttons (Bottom Right) -->
      <div class="nav-buttons">
        <button
          class="nav-btn"
          (click)="previousCity()"
          [disabled]="currentCityIndex === 0"
        >
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 19l-7-7 7-7"
            />
          </svg>
          Previous
        </button>
        <button class="nav-btn primary" (click)="nextCity()">
          Next
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 5l7 7-7 7"
            />
          </svg>
        </button>
      </div>

      <!-- Playback Progress -->
      <div class="playback-progress" *ngIf="isPlaying">
        <svg viewBox="0 0 36 36">
          <path
            d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
            fill="none"
            stroke="#e5e7eb"
            stroke-width="3"
          />
          <path
            d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
            fill="none"
            stroke="#6366f1"
            stroke-width="3"
            [attr.stroke-dasharray]="'100 100'"
            [attr.stroke-dashoffset]="100 - timelineProgress"
          />
        </svg>
        <span class="progress-text"
          >{{ currentCityIndex + 1 }}/{{ cities.length }}</span
        >
      </div>
    </div>
  </div>
</div>
