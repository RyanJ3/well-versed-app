<div class="verse-workspace-container" (mouseup)="handleMouseUp()">
  <!-- NEW Glassmorphism Header Component (includes chapter navigation) -->
  <app-workspace-header
    [currentBook]="currentBook"
    [currentChapter]="currentChapter"
    [totalChapters]="currentBook?.totalChapters || 50"
    [memorizedVersesCount]="memorizedVersesCount"
    [totalVerses]="verses.length"
    [progressPercentage]="progressPercentage"
    [selectedVersesCount]="selectionService.selectedVerses.size"
    [showFullText]="showFullText"
    [availableChapters]="availableChapters"
    [allBooks]="allBooks"
    [mode]="modeString"
    [selectedVerseNumber]="selectedCrossRefVerse?.verse || 1"
    [availableVerseNumbers]="currentBibleChapter ? getVerseNumbersArray() : []"
    [memorizedVerses]="getMemorizedVerseNumbers()"
    [hasApocrypha]="hasApocrypha"
    (toggleTextMode)="toggleTextMode()"
    (startFullChapter)="startFullChapter()"
    (startStudySession)="startStudySession()"
    (changeChapter)="changeChapter($event)"
    (changeBook)="changeBook($event)"
    (verseNumberChange)="onCrossRefVerseChange($event)"
    (modeChange)="onModeChange($event)"
  >
    <!-- Topic Picker for Topical Mode (included via ng-content) -->
    <app-topic-picker
      *ngIf="mode === WorkspaceMode.TOPICAL"
      [selectedTopicId]="selectedTopic?.topicId"
      (topicSelected)="onTopicSelected($event)"
    ></app-topic-picker>
  </app-workspace-header>

  <!-- Main Layout with Sidebar -->
  <div class="main-layout">
    <!-- Left Sidebar -->
    <div class="sidebar">
      <!-- Quick Filters -->
      <app-workspace-filters
        [activeFilter]="activeFilter"
        [totalVerses]="mode === WorkspaceMode.CHAPTER ? verses.length : (mode === WorkspaceMode.CROSS_REFERENCES ? crossReferenceVerses.length : (mode === WorkspaceMode.TOPICAL ? topicalVerses.length : 0))"
        [unmemorizedCount]="mode === WorkspaceMode.CHAPTER ? unmemorizedVersesCount : (mode === WorkspaceMode.CROSS_REFERENCES ? getUnmemorizedCrossRefCount() : (mode === WorkspaceMode.TOPICAL ? getUnmemorizedTopicalCount() : 0))"
        [needsReviewCount]="needsReviewCount"
        [showReviewFilter]="mode === WorkspaceMode.CHAPTER"
        (filterChange)="uiStateService.setActiveFilter($event)"
      ></app-workspace-filters>

      <!-- Chapter Actions Section (only in memorization mode) -->
      <div class="chapter-actions-section" *ngIf="mode === WorkspaceMode.CHAPTER">
        <h3 class="section-title">Actions</h3>
        
        <!-- Start Chapter Button -->
        <button class="action-btn start-chapter-btn" (click)="startFullChapter()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
            <path d="M8 5v14l11-7z" />
          </svg>
          Start Full Chapter
        </button>
      </div>

      <!-- Selection Info (only in memorization mode) -->
      <div class="selection-info" *ngIf="mode === WorkspaceMode.CHAPTER">
        <div class="selection-text">
          <span>{{ selectionService.selectedVerses.size }} verses selected</span>
          <small>Shift+Click for range ‚Ä¢ Ctrl/Cmd+A for all</small>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons" *ngIf="selectionService.selectedVerses.size > 0">
          <!-- Memorization Actions -->
          <button 
            *ngIf="shouldShowMarkAsMemorized"
            (click)="markSelectedAsMemorized()" 
            class="action-btn memorize-btn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
            Mark as Memorized
          </button>

          <button 
            *ngIf="shouldShowMarkAsUnmemorized"
            (click)="markSelectedAsUnmemorized()" 
            class="action-btn unmemorize-btn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="15" y1="9" x2="9" y2="15"></line>
              <line x1="9" y1="9" x2="15" y2="15"></line>
            </svg>
            Mark as Unmemorized
          </button>

          <!-- Study Action -->
          <button 
            (click)="startStudySession()" 
            class="action-btn study-btn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
              <polyline points="9,22 9,12 15,12 15,22"></polyline>
            </svg>
            Study Selected
          </button>

          <!-- Deck Actions -->
          <div class="deck-actions">
            <button 
              *ngFor="let deckName of flashcardDeckNames" 
              (click)="addToFlashcardDeck(deckName)"
              class="action-btn deck-btn">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14,2 14,8 20,8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
                <polyline points="10,9 9,9 8,9"></polyline>
              </svg>
              Add to {{ deckName }}
            </button>

            <button 
              (click)="openCreateDeckModal()" 
              class="action-btn create-deck-btn">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="16"></line>
                <line x1="8" y1="12" x2="16" y2="12"></line>
              </svg>
              Create New Deck
            </button>
          </div>
        </div>

        <button (click)="selectionService.clearSelection()" class="clear-selection-btn">
          Clear (Esc)
        </button>
      </div>
    </div>

    <!-- Main Content Area -->
    <div class="content-area">
      <!-- Encouragement Message -->
      <div class="encouragement-message" *ngIf="showEncouragement" [@fadeInOut]>
        {{ showEncouragement }}
      </div>
      
      <!-- Verses Container -->
      <div class="verses-container" #versesContainer>
    <div class="instructions" *ngIf="verses.length === 0 && !isLoading">
      Right-click for options ‚Ä¢ Space to select ‚Ä¢ Enter to study ‚Ä¢ Arrow keys to navigate
    </div>

    <!-- Loading State -->
    <div *ngIf="isLoading" class="loading-state">
      <div class="spinner"></div>
      <p>Loading verses...</p>
    </div>


    <!-- Regular Grid View (only in memorization mode) -->
    <app-verse-list
      *ngIf="mode === WorkspaceMode.CHAPTER && !isLoading && verses.length > 0"
      [verses]="verses"
      [filteredVerses]="getFilteredVerses()"
      [selectedVerses]="selectionService.selectedVerses"
      [showFullText]="showFullText"
      [fontSize]="fontSize"
      [layoutMode]="layoutMode"
      [verseReviewData]="verseReviewData"
      [mode]="modeString"
      [isRTL]="isRTL"
      (verseClick)="handleVerseClick($event.index, $event.event)"
      (verseDoubleClick)="handleVerseDoubleClick($event)"
      (verseContextMenu)="handleContextMenu($event.event, $event.verse)"
      (verseMouseDown)="handleMouseDown($event)"
      (verseMouseEnter)="handleMouseEnter($event)"
      (verseMouseUp)="handleMouseUp()"
    ></app-verse-list>
    
    <!-- Cross-References View (replaces all verses when in this mode) -->
    <div *ngIf="mode === WorkspaceMode.CROSS_REFERENCES" class="cross-references-container">
      
      <!-- Cross-references grid -->
      <div *ngIf="!loadingCrossReferences && crossReferenceVerses.length > 0" class="verses-grid cross-references-grid">
      <!-- Selected Verse Card (highlighted) -->
      <div class="selected-verse-card" *ngIf="selectedCrossRefVerse">
        <div class="card-header">
          <span class="card-label">Selected Verse</span>
          <span class="card-reference">{{ selectedCrossRefVerse.displayText }}</span>
        </div>
        <div class="card-text" [dir]="isRTL ? 'rtl' : 'ltr'">{{ selectedCrossRefVerse.text || 'Loading verse text...' }}</div>
      </div>
      
      <!-- Cross-Reference Cards -->
      <div
        *ngFor="let verse of getFilteredCrossReferences(); let i = index"
        class="verse-block"
        [class.memorized]="verse.isMemorized"
        [class.selected]="isVerseSelected(verse)"
        [style.fontSize.px]="fontSize"
        (click)="handleCrossRefClick(verse, $event)"
        (dblclick)="navigateToVerse(verse)"
        (contextmenu)="handleContextMenu($event, verse)"
        (mousedown)="handleCrossRefMouseDown(i)"
        (mouseenter)="handleCrossRefMouseEnter(i)"
      >
        <div class="verse-checkmark" *ngIf="verse.isMemorized" (click)="toggleMemorized(verse); $event.stopPropagation(); $event.preventDefault()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
        </div>
        
        <div class="verse-selected-check" *ngIf="isVerseSelected(verse) && !verse.isMemorized">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
        </div>
        
        <div class="verse-ref">
          {{ verse.fullReference }}
          <span *ngIf="verse.isRange" class="verse-range-indicator" title="{{ verse.verseCount }} verses">
            ({{ verse.verseCount }} verses)
          </span>
        </div>
        <div class="verse-text" [class.full-text]="showFullText" [dir]="isRTL ? 'rtl' : 'ltr'">
          {{ verse.text }}
        </div>
        
        <!-- Additional metadata -->
        <div class="cross-ref-metadata">
          <span class="ref-direction" [class.from]="verse.direction === 'from'" [class.to]="verse.direction === 'to'">
            {{ verse.direction === 'from' ? '‚Üê Referenced by' : '‚Üí References' }}
          </span>
          <span class="confidence-dots">
            <span *ngFor="let dot of [1,2,3,4,5]" 
                  class="dot" 
                  [class.filled]="(verse.crossRefConfidence || 0) >= (dot * 0.2)">
              ‚Ä¢
            </span>
          </span>
        </div>
      </div>
      </div>
      
      <!-- Empty State for Cross-References -->
      <div *ngIf="!loadingCrossReferences && crossReferenceVerses.length === 0 && selectedCrossRefVerse" class="empty-state">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
        </svg>
        <p>No cross-references found for this verse</p>
      </div>
      
      <!-- Loading state -->
      <div *ngIf="loadingCrossReferences" class="loading-state">
        <div class="spinner"></div>
        <p>Loading cross-references...</p>
      </div>
    </div>

    <!-- Topical Verses View -->
    <div *ngIf="mode === WorkspaceMode.TOPICAL" class="topical-verses-container">
      
      
      <!-- Topical verses grid -->
      <div *ngIf="!loadingTopicalVerses && topicalVerses.length > 0" class="verses-grid topical-verses-grid">
        <div
          *ngFor="let verse of getFilteredTopicalVerses(); let i = index"
          class="verse-block"
          [class.memorized]="verse.isMemorized"
          [class.selected]="isVerseSelected(verse)"
          [style.fontSize.px]="fontSize"
          (click)="handleTopicalClick(verse, $event)"
          (dblclick)="navigateToVerse(verse)"
          (contextmenu)="handleContextMenu($event, verse)"
          (mousedown)="handleTopicalMouseDown(i)"
          (mouseenter)="handleTopicalMouseEnter(i)"
        >
          <div class="verse-checkmark" *ngIf="verse.isMemorized" (click)="toggleMemorized(verse); $event.stopPropagation(); $event.preventDefault()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
          </div>
          
          <div class="verse-selected-check" *ngIf="isVerseSelected(verse) && !verse.isMemorized">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
          </div>
          
          <div class="verse-ref">{{ verse.fullReference }}</div>
          <div class="verse-text" [class.full-text]="showFullText" [dir]="isRTL ? 'rtl' : 'ltr'">
            {{ verse.text }}
          </div>
          
          <!-- Relevance indicator -->
          <div class="topic-metadata">
            <div class="relevance-bar">
              <div class="relevance-fill" [style.width.%]="(verse.topicRelevance || 0) * 100"></div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Empty State for No Topic Selected -->
      <div *ngIf="!loadingTopicalVerses && !selectedTopic" class="empty-state">
        <div class="empty-icon">üìñ</div>
        <p>Select a topic above to explore verses</p>
      </div>
      
      <!-- Empty State for No Verses Found -->
      <div *ngIf="!loadingTopicalVerses && selectedTopic && topicalVerses.length === 0" class="empty-state">
        <div class="empty-icon">üîç</div>
        <p>No verses found for "{{ selectedTopic?.topicName }}"</p>
      </div>
      
      <!-- Loading state -->
      <div *ngIf="loadingTopicalVerses" class="loading-state">
        <div class="spinner"></div>
        <p>Loading verses...</p>
      </div>
    </div>
      </div> <!-- Close verses-container -->
    </div> <!-- Close content-area -->
  </div> <!-- Close main-layout -->

  <!-- Context Menu -->
  <app-workspace-context-menu
    *ngIf="contextMenu.visible"
    [contextMenu]="contextMenu"
    [flashcardDecks]="flashcardDeckNames"
    [selectedVerseIsMemorized]="selectedVerseIsMemorized"
    [shouldShowMarkAsMemorized]="shouldShowMarkAsMemorized"
    [shouldShowMarkAsUnmemorized]="shouldShowMarkAsUnmemorized"
    [shouldShowJumpToChapter]="shouldShowJumpToChapter"
    (markAsMemorized)="markSelectedAsMemorized()"
    (markAsUnmemorized)="markSelectedAsUnmemorized()"
    (addToDeck)="addToFlashcardDeck($event)"
    (createDeck)="openCreateDeckModal()"
    (jumpToCrossReferences)="jumpToCrossReferencesFromContextMenu()"
    (copyText)="copyVerseText()"
    (jumpToChapter)="jumpToFullChapter()"
  ></app-workspace-context-menu>

  <!-- Memorization Modal -->
  <app-memorization-modal
    *ngIf="showModal"
    [verses]="modalVerses"
    [chapterId]="currentBook?.id || 0"
    [chapterName]="modalChapterName"
    [verseCount]="modalVerses.length"
    (completed)="onModalCompleted($event)"
  ></app-memorization-modal>

  <!-- Create Deck Modal -->
  <app-create-deck-modal
    *ngIf="showCreateDeckModal"
    [show]="showCreateDeckModal"
    [isLoading]="createDeckLoading"
    (close)="closeCreateDeckModal()"
    (create)="handleCreateDeck($event)"
  ></app-create-deck-modal>
</div>