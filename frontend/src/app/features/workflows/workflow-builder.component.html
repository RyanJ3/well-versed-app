<!-- frontend/src/app/features/workflows/workflow-builder.component.html -->
<div class="workflow-builder">
  <!-- Header -->
  <div class="builder-header">
    <h1>{{ isEditMode ? 'Edit Workflow' : 'Create New Workflow' }}</h1>
    <div class="header-actions">
      <button class="btn btn-secondary" (click)="cancel()">Cancel</button>
      <button class="btn btn-primary" (click)="saveWorkflow()" [disabled]="saving">
        {{ saving ? 'Saving...' : 'Save Workflow' }}
      </button>
    </div>
  </div>

  <!-- Step Navigation -->
  <div class="step-navigation">
    <div 
      *ngFor="let step of steps" 
      class="step-item"
      [class.completed]="getStepStatus(step.number) === 'completed'"
      [class.active]="getStepStatus(step.number) === 'active'"
      (click)="goToStep(step.number)"
    >
      <div class="step-number">
        <span *ngIf="getStepStatus(step.number) !== 'completed'">{{ step.number }}</span>
        <svg *ngIf="getStepStatus(step.number) === 'completed'" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
          <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
        </svg>
      </div>
      <div class="step-info">
        <div class="step-title">{{ step.title }}</div>
        <div class="step-description">{{ step.description }}</div>
      </div>
    </div>
  </div>

  <!-- Step 1: Workflow Info -->
  <div class="workflow-info" [formGroup]="workflowForm" *ngIf="currentStep === 1">
    <div class="form-group">
      <label>Workflow Title <span class="required">*</span></label>
      <input 
        type="text" 
        class="form-control" 
        formControlName="title"
        placeholder="Enter a title for your workflow"
      >
      <div class="error-message" *ngIf="workflowForm.get('title')?.touched && workflowForm.get('title')?.errors?.['required']">
        Title is required
      </div>
    </div>

    <div class="form-group">
      <label>Description <span class="required">*</span></label>
      <textarea 
        class="form-control" 
        formControlName="description"
        rows="3"
        placeholder="Describe what learners will gain from this workflow"
      ></textarea>
      <div class="error-message" *ngIf="workflowForm.get('description')?.touched && workflowForm.get('description')?.errors?.['required']">
        Description is required
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>Tags</label>
        <div class="tags-container">
          <div class="selected-tags">
            <span 
              *ngFor="let tag of selectedTags" 
              class="tag-chip"
              (click)="removeTag(tag)"
            >
              {{ formatTag(tag) }}
              <span class="remove-icon">Ã—</span>
            </span>
          </div>
          <select 
            class="form-control tag-select" 
            #tagSelect
            (change)="addTag(tagSelect.value); tagSelect.value = ''"
          >
            <option value="">Add a tag...</option>
            <option 
              *ngFor="let tag of availableTags" 
              [value]="tag"
              [disabled]="selectedTags.includes(tag)"
            >
              {{ formatTag(tag) }}
            </option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label class="checkbox-label">
          <input type="checkbox" formControlName="is_public">
          Make this workflow public
        </label>
        <p class="help-text">Public workflows can be discovered by other users</p>
      </div>
    </div>

    <div class="step-footer">
      <button class="btn btn-primary" (click)="nextStep()" [disabled]="!canProceed()">
        Next Step
      </button>
    </div>
  </div>

  <!-- Step 2: Side by Side Editor -->
  <div class="editor-container" *ngIf="currentStep === 2">
    <!-- Left Panel: Lesson List -->
    <div class="editor-panel lessons-panel">
      <div class="panel-header">
        <h3>Workflow Structure</h3>
        <span class="lesson-count">{{ lessons.length }} lessons</span>
      </div>

      <div class="lesson-list">
        <div 
          *ngFor="let lesson of lessons; let i = index"
          class="lesson-card"
          [class.active]="selectedLessonIndex === i"
          (click)="selectLesson(i)"
        >
          <div class="lesson-handle">
            <div class="reorder-buttons">
              <button 
                class="reorder-btn"
                (click)="moveLesson(i, 'up'); $event.stopPropagation()"
                [disabled]="i === 0"
                title="Move up"
              >
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M7 14l5-5 5 5z"/>
                </svg>
              </button>
              <button 
                class="reorder-btn"
                (click)="moveLesson(i, 'down'); $event.stopPropagation()"
                [disabled]="i === lessons.length - 1"
                title="Move down"
              >
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M7 10l5 5 5-5z"/>
                </svg>
              </button>
            </div>
            <div class="lesson-number">{{ i + 1 }}</div>
            <div class="lesson-info">
              <div class="lesson-title">{{ lesson.title }}</div>
              <div class="lesson-type">
                {{ getLessonIcon(lesson.content_type) }} {{ getLessonTypeLabel(lesson.content_type) }}
              </div>
            </div>
            <button 
              class="delete-btn"
              (click)="deleteLesson(i); $event.stopPropagation()"
              title="Delete lesson"
            >
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
              </svg>
            </button>
          </div>
        </div>

        <button class="add-lesson-btn" (click)="addLesson()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
          </svg>
          <span>Add New Lesson</span>
        </button>
      </div>
    </div>

    <!-- Right Panel: Lesson Editor -->
    <div class="editor-panel content-panel">
      <div class="panel-header" *ngIf="selectedLessonIndex !== null">
        <h3>Lesson {{ selectedLessonIndex + 1 }}: {{ lessons[selectedLessonIndex].title }}</h3>
      </div>

      <div class="empty-state" *ngIf="selectedLessonIndex === null">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
        </svg>
        <p>Select a lesson to edit or create a new one</p>
      </div>

      <form [formGroup]="lessonForm" *ngIf="selectedLessonIndex !== null">
        <div class="form-group">
          <label>Lesson Title <span class="required">*</span></label>
          <input 
            type="text" 
            class="form-control" 
            formControlName="title"
            placeholder="Enter lesson title"
          >
        </div>

        <div class="form-group">
          <label>Description</label>
          <textarea 
            class="form-control" 
            formControlName="description"
            rows="2"
            placeholder="Brief description of the lesson (optional)"
          ></textarea>
        </div>

        <div class="form-group">
          <label>Content Type <span class="required">*</span></label>
          <div class="content-type-selector">
            <div 
              class="type-option"
              [class.selected]="lessonForm.get('content_type')?.value === 'video'"
              (click)="lessonForm.patchValue({content_type: 'video'})"
            >
              <div class="type-icon">ðŸ“¹</div>
              <div>Video</div>
            </div>
            <div 
              class="type-option"
              [class.selected]="lessonForm.get('content_type')?.value === 'article'"
              (click)="lessonForm.patchValue({content_type: 'article'})"
            >
              <div class="type-icon">ðŸ“„</div>
              <div>Article</div>
            </div>
            <div 
              class="type-option"
              [class.selected]="lessonForm.get('content_type')?.value === 'external_link'"
              (click)="lessonForm.patchValue({content_type: 'external_link'})"
            >
              <div class="type-icon">ðŸ”—</div>
              <div>External</div>
            </div>
          </div>
        </div>

        <!-- Video Content -->
        <div class="content-fields" *ngIf="lessonForm.get('content_type')?.value === 'video'">
          <div class="form-group">
            <label>YouTube URL <span class="required">*</span></label>
            <input 
              type="url" 
              class="form-control" 
              formControlName="youtube_url"
              placeholder="https://www.youtube.com/watch?v=..."
            >
            <p class="help-text">Paste the full YouTube video URL</p>
          </div>
        </div>

        <!-- Article Content -->
        <div class="content-fields" *ngIf="lessonForm.get('content_type')?.value === 'article'">
          <div class="form-group">
            <label>Article Content <span class="required">*</span></label>
            <textarea 
              class="form-control article-textarea" 
              formControlName="article_text"
              rows="10"
              placeholder="Write your article content here..."
            ></textarea>
            <div class="char-count">
              {{ lessonForm.get('article_text')?.value?.length || 0 }} characters
              <span *ngIf="lessonForm.get('article_text')?.errors?.['minLength']" class="error">
                (minimum 100)
              </span>
            </div>
          </div>
        </div>

        <!-- External Link Content -->
        <div class="content-fields" *ngIf="lessonForm.get('content_type')?.value === 'external_link'">
          <div class="form-group">
            <label>External URL <span class="required">*</span></label>
            <input 
              type="url" 
              class="form-control" 
              formControlName="external_url"
              placeholder="https://example.com/resource"
            >
          </div>
          <div class="form-group">
            <label>Link Title</label>
            <input 
              type="text" 
              class="form-control" 
              formControlName="external_title"
              placeholder="Title for the external resource"
            >
          </div>
        </div>

        <!-- Common Fields -->
        <div class="form-group">
          <label>Audio Narration (Optional)</label>
          <input 
            type="url" 
            class="form-control" 
            formControlName="audio_url"
            placeholder="https://example.com/audio.mp3"
          >
          <p class="help-text">Add an audio file URL for narration</p>
        </div>

        <div class="form-group">
          <label>Required Flashcards</label>
          <input 
            type="number" 
            class="form-control" 
            formControlName="flashcards_required"
            min="1"
            max="20"
            style="width: 100px;"
          >
          <p class="help-text">Number of flashcards students must complete to unlock the next lesson</p>
        </div>

        <div class="lesson-actions">
          <button 
            type="button" 
            class="btn btn-primary" 
            (click)="saveLessonToMemory()"
            [disabled]="!lessonForm.valid"
          >
            Save Lesson Changes
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Step 3: Review -->
  <div class="review-section" *ngIf="currentStep === 3">
    <div class="review-content">
      <h2>Review Your Workflow</h2>
      
      <div class="review-card">
        <h3>{{ workflowForm.get('title')?.value }}</h3>
        <p>{{ workflowForm.get('description')?.value }}</p>
        
        <div class="review-meta">
          <div class="meta-item">
            <strong>Visibility:</strong> 
            {{ workflowForm.get('is_public')?.value ? 'Public' : 'Private' }}
          </div>
          <div class="meta-item">
            <strong>Total Lessons:</strong> {{ lessons.length }}
          </div>
          <div class="meta-item" *ngIf="selectedTags.length > 0">
            <strong>Tags:</strong> 
            <span class="tag-chip" *ngFor="let tag of selectedTags">{{ formatTag(tag) }}</span>
          </div>
        </div>
      </div>

      <div class="lessons-review">
        <h3>Lessons</h3>
        <div class="review-lesson" *ngFor="let lesson of lessons; let i = index">
          <div class="lesson-number">{{ i + 1 }}</div>
          <div class="lesson-details">
            <strong>{{ lesson.title }}</strong>
            <span class="lesson-type">{{ getLessonIcon(lesson.content_type) }} {{ getLessonTypeLabel(lesson.content_type) }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Step Footer -->
  <div class="step-footer" *ngIf="currentStep > 1">
    <button class="btn btn-secondary" (click)="previousStep()">
      Previous Step
    </button>
    <button 
      class="btn btn-primary" 
      (click)="nextStep()" 
      [disabled]="!canProceed()"
      *ngIf="currentStep < 3"
    >
      Next Step
    </button>
  </div>
</div>