<!-- frontend/src/app/shared/components/memorization-modal/memorization-modal.component.html -->
<div class="memorization-modal-overlay" *ngIf="visible">
  <div class="memorization-modal-container" @fadeIn>
    <!-- Exit Button -->
    <button class="exit-btn" (click)="confirmExit()">√ó</button>

    <div class="modal-header">
      <div class="header-row">
        <h2>{{ displayChapterName }}</h2>
        <div class="header-controls">
          <!-- Timer Display -->
          <div class="timer-display" *ngIf="!setup && !promptSave">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
            <span>{{ elapsedTime }}</span>
          </div>
          <!-- Settings Button -->
          <button class="settings-btn" *ngIf="!setup && !promptSave" (click)="toggleSettings()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="3"></circle>
              <path d="M12 1v6m0 6v6m3.22-10.22l4.24-4.24m-4.24 13.68l4.24 4.24M20 12h-6m-8 0H1m3.22-9.46L8.46 7.78m0 8.44l-4.24 4.24"></path>
            </svg>
          </button>
          <div class="progress-info">
            <span class="progress-text">{{ progressPercentage }}% Complete</span>
          </div>
        </div>
      </div>

      <div class="verse-bubbles-wrapper">
        <div class="verse-bubbles-container" #verseBubblesContainer>
          <div class="verse-bubbles" [class.review-phase]="currentStageIndex > 0">
            <div 
              class="active-border-container" 
              *ngIf="hasActiveBorder" 
              [style.left.px]="borderLeft" 
              [style.width.px]="borderWidth"
              @borderPulse
            >
              <div class="active-border-bg"></div>
              <div class="active-border-glow"></div>
            </div>
            <ng-container *ngFor="let group of getOriginalGroups(); let i = index">
              <div
                class="group-bubble"
                [class.completed]="isGroupCompleted(i)"
                [class.current]="isGroupActive(i)"
                [class.reset]="shouldShowAsReset(i)"
                [class.merge-left]="shouldMergeWithPrev(i)"
                (mouseenter)="hoveredGroup = i"
                (mouseleave)="hoveredGroup = -1"
                [class.hovered]="hoveredGroup === i"
              >
                <div class="verse-numbers">
                  <div *ngFor="let verse of group" class="verse-number">
                    {{ verse.verse }}
                  </div>
                </div>
                <!-- stage dots are now positioned centrally for merged groups -->
                <span class="check-icon" *ngIf="isCheckmarkIndex(i) && !shouldShowAsReset(i)">‚úì</span>
              </div>
            </ng-container>
            <div class="stage-dots-overlay" *ngIf="showStageDots && !setup" [style.left.px]="stageDotsLeft">
              <div class="stage-dot" [class.completed]="currentStepIndex > 0"></div>
              <div class="stage-dot" [class.completed]="currentStepIndex > 1" [class.active]="currentStepIndex === 1"></div>
              <div class="stage-dot" [class.active]="currentStepIndex === 2"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="progress-journey">
        <div class="journey-path">
          <svg class="path-svg" viewBox="0 0 100 20" preserveAspectRatio="none">
            <path 
              class="path-bg" 
              d="M 0 10 Q 25 5, 50 10 T 100 10" 
              stroke="#e5e7eb" 
              stroke-width="4" 
              fill="none"
            />
            <path 
              class="path-progress" 
              d="M 0 10 Q 25 5, 50 10 T 100 10" 
              [attr.stroke]="getProgressColor()"
              stroke-width="4" 
              fill="none"
              [style.stroke-dasharray]="'100'"
              [style.stroke-dashoffset]="100 - progressPercentage"
              @progressPath
            />
          </svg>
          <div class="progress-shimmer" [style.width.%]="progressPercentage"></div>
        </div>
        <div class="progress-markers">
          <div
            *ngFor="let marker of progressMarkers"
            class="marker"
            [class.star-marker]="marker.type === 'star'"
            [class.flag-marker]="marker.type === 'flag'"
            [class.finish-marker]="marker.type === 'finish'"
            [style.left.%]="marker.position"
            [id]="marker.id"
          >
            <!-- Star Marker -->
            <div *ngIf="marker.type === 'star'" class="star-container">
              <svg 
                class="star-outline" 
                width="24" 
                height="24" 
                viewBox="0 0 24 24" 
                fill="none"
              >
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" 
                      stroke="#9ca3af" 
                      stroke-width="2" 
                      stroke-linejoin="round"/>
              </svg>
              <svg 
                *ngIf="marker.completed"
                class="star-filled" 
                width="24" 
                height="24" 
                viewBox="0 0 24 24" 
                fill="#fbbf24"
                @starFill
              >
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
              </svg>
            </div>

            <!-- Flag Marker -->
            <div *ngIf="marker.type === 'flag'" class="flag-container">
              <div 
                class="flag"
                [class.completed]="marker.completed"
                *ngIf="marker.completed"
                @flagRaise
              >
                üö©
              </div>
              <div class="flag-pole" [class.completed]="marker.completed"></div>
              <span class="flag-label">{{ marker.label }}</span>
            </div>

            <!-- Finish Marker -->
            <div *ngIf="marker.type === 'finish'" class="finish-container">
              <div class="finish-icon" [class.completed]="marker.completed">
                <span *ngIf="!marker.completed">üèÅ</span>
                <span *ngIf="marker.completed" @trophyBounce>üèÜ</span>
              </div>
              <span class="finish-label">{{ marker.label }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-content">
      <!-- Setup Stage -->
      <ng-container *ngIf="setup">
        <div class="setup" @slideUp>
          <div class="setup-header">
            <h2>Let's Start Memorizing!</h2>
            <p class="setup-subtitle">Choose how many verses you'd like to practice at once</p>
          </div>
          
          <div class="group-selector">
            <div 
              class="group-option" 
              *ngFor="let s of [1, 2, 3]"
              (click)="setGroupSize(s)"
              [class.active]="groupSize === s"
              @optionHover
            >
              <div class="option-icon">
                <span class="verse-count">{{ s }}</span>
              </div>
              <div class="option-label">
                {{ s === 1 ? 'One at a time' : s === 2 ? 'Pairs' : 'Triplets' }}
              </div>
              <div class="option-description">
                {{ s === 1 ? 'Best for beginners' : s === 2 ? 'Recommended' : 'Challenge mode' }}
              </div>
            </div>
          </div>

          <div class="setup-preview">
            <p>You'll practice {{ getGroupCount() }} groups of verses</p>
            <p class="time-estimate">Estimated time: {{ estimatedTime }} minutes</p>
          </div>

          <button class="start-btn" (click)="start()">
            <span>Begin Memorization</span>
            <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
              <path d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z"/>
            </svg>
          </button>
        </div>
      </ng-container>

      <!-- Settings Panel -->
      <div class="settings-panel" *ngIf="showSettings && !setup && !promptSave" @slideUp>
        <h3>Display Settings</h3>
        
        <div class="setting-group">
          <label class="setting-label">Font Size</label>
          <div class="font-controls">
            <button class="font-btn" (click)="decreaseFontSize()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
            </button>
            <span class="font-value">{{ settings.fontSize }}px</span>
            <button class="font-btn" (click)="increaseFontSize()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
            </button>
          </div>
        </div>

        <div class="setting-group">
          <label class="setting-label">Display Mode</label>
          <div class="display-options">
            <label class="radio-option">
              <input type="radio" name="displayMode" value="single" 
                     [(ngModel)]="settings.displayMode" (change)="saveSettings()">
              <span>Verse by Verse</span>
            </label>
            <label class="radio-option" *ngIf="currentVerses.length < 6">
              <input type="radio" name="displayMode" value="grid" 
                     [(ngModel)]="settings.displayMode" (change)="saveSettings()">
              <span>{{ getGridColumnCount() }}-Column Grid</span>
            </label>
          </div>
        </div>
      </div>

      <!-- Practice Stage -->
      <ng-container *ngIf="!setup && !promptSave && currentStage">
        <div class="practice-wrapper" [class.with-settings]="showSettings">
          <div class="practice-header">
            <div class="stage-indicators-compact" @slideUp>
              <div
                class="stage-compact"
                *ngFor="let s of stageNames; let i = index"
                [attr.data-tooltip]="s"
              >
                <div
                  class="stage-circle-compact"
                  [class.active]="currentStepIndex === i"
                  [class.completed]="currentStepIndex > i"
                  [style.background]="getStageColor(i)"
                >
                  <span class="stage-icon" [innerHTML]="getStageIcon(s)"></span>
                </div>
              </div>
            </div>

            <p class="group-progress">{{ progressDetail }}</p>
            <p class="instructions">{{ currentInstruction }}</p>
          </div>

          <div class="verse-display" [style.font-size.px]="settings.fontSize">
            <!-- Single Verse Display Mode -->
            <div *ngIf="settings.displayMode === 'single'" class="single-mode">
              <div
                class="verse-block"
                *ngFor="let v of currentVerses; let idx = index"
                [@verseTransition]="currentStepIndex"
              >
                <p class="verse-ref">{{ v.reference }}</p>
                <p class="verse-text" [class.memory-mode]="currentStepIndex === 2">{{ getVerseDisplay(v) }}</p>
              </div>
            </div>

            <!-- Grid Display Mode -->
            <div *ngIf="settings.displayMode === 'grid' && currentVerses.length < 6" class="grid-mode">
              <div class="verse-grid" [class.cols-3]="currentVerses.length === 3"
                                     [class.cols-4]="currentVerses.length === 4"
                                     [class.cols-5]="currentVerses.length === 5">
                <div
                  class="verse-cell"
                  *ngFor="let v of currentVerses; let idx = index"
                  [@verseTransition]="currentStepIndex"
                >
                  <p class="verse-ref">{{ v.reference }}</p>
                  <p class="verse-text" [class.memory-mode]="currentStepIndex === 2">{{ getVerseDisplay(v) }}</p>
                </div>
              </div>
            </div>
          </div>

          <div class="nav-buttons">
            <button class="prev-btn" (click)="prev()" [disabled]="!canGoBack">
              Previous
            </button>
            <button class="next-btn" (click)="next()" [disabled]="isSaving">Next</button>
          </div>
        </div>
      </ng-container>

      <!-- Save Prompt -->
      <ng-container *ngIf="promptSave">
        <div class="completion-wrapper">
          <!-- Confetti Animation (auto-stops) -->
          <div class="confetti-container" *ngIf="showConfetti">
            <div *ngFor="let i of [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15]" class="confetti" [style.--index]="i"></div>
          </div>
          
          <div class="completion-message" @celebration>
            <div class="celebration-icon">
              <span class="trophy-icon" @trophyBounce>üèÜ</span>
            </div>
            
            <p class="completion-text">You've successfully memorized {{ displayChapterName }}!</p>
            
            <!-- Special message for completing the Bible -->
            <p class="bible-complete-message" *ngIf="isLastChapterOfBible">
              üéâ Congratulations! You've completed the entire Bible! üéâ
            </p>
            
            <div class="completion-stats">
              <div class="stat" @statReveal>
                <span class="stat-value">{{ verses.length }}</span>
                <span class="stat-label">Verses</span>
              </div>
              <div class="stat" @statReveal>
                <span class="stat-value">{{ formatTime(timeSpent) }}</span>
                <span class="stat-label">Time</span>
              </div>
            </div>
            
            <!-- Mark Complete Section -->
            <div class="complete-section" *ngIf="!hasMarkedComplete">
              <p class="save-prompt">Would you like to mark this chapter as memorized?</p>
              <div class="completion-buttons">
                <button class="secondary-btn" (click)="exitWithoutSaving()" [disabled]="isSaving">
                  Exit without Saving
                </button>
                <button class="primary-btn mark-complete-btn" (click)="markAsComplete()" [disabled]="isSaving">
                  <span *ngIf="!isSaving">Save</span>
                  <span *ngIf="isSaving" class="spinner-container">
                    <span class="spinner"></span>
                  </span>
                </button>
              </div>
              
              <!-- Error Message -->
              <div class="error-message" *ngIf="saveError" @fadeInOut>
                <span class="error-icon">‚ö†Ô∏è</span>
                <span>Failed to save. Please try again.</span>
              </div>
            </div>

            <!-- Success Check Animation -->
            <div class="success-check-container" *ngIf="showSuccessCheck" @checkmark>
              <svg class="checkmark-svg" width="64" height="64" viewBox="0 0 64 64">
                <circle cx="32" cy="32" r="30" fill="none" stroke="#10b981" stroke-width="4"/>
                <path d="M20 32 L28 40 L44 24" fill="none" stroke="#10b981" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>

          </div>
        </div>
        <div class="final-nav-buttons" *ngIf="showNavigationOptions">
          <button class="secondary-btn" (click)="goToTracker()">View Progress</button>
          <button class="primary-btn" (click)="goToFlow()" *ngIf="!isLastChapterOfBible">Next Chapter</button>
          <button class="prev-btn" (click)="closeModal()">Close</button>
        </div>
      </ng-container>
    </div>

    <!-- Floating Notifications -->
    <div class="floating-notification" *ngIf="floatingMessage" @floatingNotification>
      {{ floatingMessage }}
    </div>

    <!-- Star Popup (positioned fixed) -->
    <div 
      *ngIf="starPopup && starPopup.show" 
      class="star-popup"
      [@popupSlide]="starPopup.show ? 'show' : 'hide'"
    >
      <span class="popup-icon">‚≠ê</span>
      <span class="popup-text">{{ starPopup.message }}</span>
    </div>

    <!-- Falling Star Animation -->
    <div class="falling-star" *ngIf="showFallingStar" [style.--start-x]="fallingStarStart.x" 
         [style.--start-y]="fallingStarStart.y" [style.--end-x]="fallingStarEnd.x" 
         [style.--end-y]="fallingStarEnd.y" @fallingStar>
      ‚≠ê
    </div>

    <!-- Particle Effect Container -->
    <div class="particle-container" *ngIf="showParticles">
      <div *ngFor="let p of particles" class="particle" [style.--x]="p.x" [style.--y]="p.y"></div>
    </div>

    <!-- Exit Confirmation Modal -->
    <div class="confirm-modal-overlay" *ngIf="showExitConfirm" (click)="cancelExit()">
      <div class="confirm-modal" (click)="$event.stopPropagation()" @slideUp>
        <h3>Exit Practice?</h3>
        <p>Your progress will be lost if you exit now.</p>
        <div class="confirm-buttons">
          <button class="secondary-btn" (click)="cancelExit()">Keep Practicing</button>
          <button class="danger-btn" (click)="confirmExitAction()">Exit</button>
        </div>
      </div>
    </div>

    <!-- Exit Without Saving Confirmation Modal -->
    <div class="confirm-modal-overlay" *ngIf="showExitWithoutSaveConfirm" (click)="cancelExitWithoutSave()">
      <div class="confirm-modal" (click)="$event.stopPropagation()" @slideUp>
        <h3>Exit Without Saving?</h3>
        <p>Your memorization progress won't be saved to your tracker. Are you sure?</p>
        <div class="confirm-buttons">
          <button class="secondary-btn" (click)="cancelExitWithoutSave()">Cancel</button>
          <button class="danger-btn" (click)="confirmExitWithoutSave()">Exit Without Saving</button>
        </div>
      </div>
    </div>
  </div>
</div>
