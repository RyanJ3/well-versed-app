<div class="memorization-modal-overlay" *ngIf="state.visible">
  <div class="memorization-modal-container" @fadeIn>
    <!-- Progress Header -->
    <app-progress-header
      [currentBook]="currentBook"
      [currentChapterNum]="currentChapterNum"
      [progressPercentage]="progressPercentage"
      [verses]="verses"
      [groupSize]="state.groupSize"
      [currentStage]="currentStage"
      [currentVerses]="currentVerses"
      [currentStepIndex]="state.currentStepIndex"
      [setup]="state.setup"
      [progressMarkers]="progressMarkers"
      [practiceSettings]="practiceSettings"
      (confirmExit)="confirmExit()"
      (settingsChange)="onSettingsChange($event)"
    ></app-progress-header>

    <div class="modal-content">
      <!-- Setup Stage -->
      <app-setup-stage
        *ngIf="state.setup"
        [verses]="verses"
        [groupSize]="state.groupSize"
        (groupSizeChange)="onGroupSizeChange($event)"
        (startPractice)="start()"
      ></app-setup-stage>

      <!-- Practice Stage -->
      <app-practice-stage
        *ngIf="!state.setup && !state.promptSave && currentStage"
        [currentVerses]="currentVerses"
        [currentStepIndex]="state.currentStepIndex"
        [practiceSettings]="practiceSettings"
        [canGoBack]="canGoBack"
        [stageNames]="stageNames"
        [isSaving]="isSaving"
        (nextStep)="next()"
        (prevStep)="prev()"
        (jumpToStep)="jumpToStep($event)"
        (settingsChange)="onSettingsChange($event)"
      ></app-practice-stage>

      <!-- Completion Stage -->
      <app-completion-stage
        *ngIf="state.promptSave"
        [currentChapterNum]="currentChapterNum"
        [verses]="verses"
        [timeSpent]="timeSpent"
        [isLastChapterOfBible]="isLastChapterOfBible"
        [nextChapterName]="nextChapterName"
        [isSaving]="isSaving"
        [saveError]="saveError"
        [hasMarkedComplete]="hasMarkedComplete"
        [showSuccessCheck]="showSuccessCheck"
        [showNavigationOptions]="showNavigationOptions"
        [showConfetti]="showConfetti"
        (markComplete)="markAsComplete()"
        (exitWithoutSave)="exitWithoutSaving()"
        (goToTracker)="goToTracker()"
        (goToFlow)="goToFlow()"
        (close)="closeModal()"
      ></app-completion-stage>
    </div>

    <!-- Floating Notifications -->
    <div
      class="floating-notification"
      *ngIf="floatingMessage"
      @floatingNotification
    >
      {{ floatingMessage }}
    </div>

    <!-- Star Popup (positioned fixed) -->
    <div
      *ngIf="starPopup && starPopup.show"
      class="star-popup"
      [@popupSlide]="starPopup.show ? 'show' : 'hide'"
      [style.visibility]="starPopup.visible ? 'visible' : 'hidden'"
    >
      <span class="popup-icon">⭐</span>
      <span class="popup-text">{{ starPopup.message }}</span>
    </div>

    <!-- Animated Star for completion -->
    <div
      *ngIf="animatedStar.show"
      class="animated-star"
      [style.left.px]="animatedStar.startX"
      [style.top.px]="animatedStar.startY"
      @starMove
      (@starMove.done)="onStarAnimationDone()"
    >
      ⭐
    </div>

    <!-- Exit Confirmation Modal -->
    <div
      class="confirm-modal-overlay"
      *ngIf="state.showExitConfirm"
      (click)="cancelExit()"
    >
      <div class="confirm-modal" (click)="$event.stopPropagation()" @slideUp>
        <h3>Exit Practice?</h3>
        <p>Your progress will be lost if you exit now.</p>
        <div class="confirm-buttons">
          <button class="secondary-btn" (click)="cancelExit()">
            Keep Practicing
          </button>
          <button class="danger-btn" (click)="confirmExitAction()">Exit</button>
        </div>
      </div>
    </div>

    <!-- Exit Without Saving Confirmation Modal -->
    <div
      class="confirm-modal-overlay"
      *ngIf="state.showExitWithoutSaveConfirm"
      (click)="cancelExitWithoutSave()"
    >
      <div class="confirm-modal" (click)="$event.stopPropagation()" @slideUp>
        <h3>Exit Without Saving?</h3>
        <p>
          Your memorization progress won't be saved to your tracker. Are you
          sure?
        </p>
        <div class="confirm-buttons">
          <button class="secondary-btn" (click)="cancelExitWithoutSave()">
            Cancel
          </button>
          <button class="danger-btn" (click)="confirmExitWithoutSave()">
            Exit Without Saving
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
